<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TunaPred Demo</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
      #chart { width: 100%; height: 70vh; }
      #status { margin: 8px 0; color: #444; }
      button { padding: 6px 12px; }
    </style>
  </head>
  <body>
    <h2>TunaPred（2023年6-7月）活动范围与可捕获指数预测</h2>
    <div class="controls">
      <button onclick="fetchData()">1) 拉取数据</button>
      <button onclick="trainModel()">2) 训练LightGBM</button>
      <select id="species">
        <option value="yellowfin">黄鳍金枪鱼</option>
        <option value="skipjack">鲣鱼(跳鲣)</option>
        <option value="albacore">长鳍金枪鱼</option>
      </select>
      <button onclick="loadPrediction()">3) 预测并可视化</button>
    </div>
    <div id="status">等待操作...</div>
    <div id="chart"></div>

    <script>
      const statusEl = document.getElementById('status');

      async function fetchData() {
        statusEl.textContent = '正在拉取GBIF + Open-Meteo开源数据...';
        const res = await fetch('/api/fetch', { method: 'POST' });
        const data = await res.json();
        statusEl.textContent = `数据完成：${data.rows}行, 时间 ${data.date_min} ~ ${data.date_max}`;
      }

      async function trainModel() {
        statusEl.textContent = '训练LightGBM(优先GPU，失败自动CPU)中...';
        const res = await fetch('/api/train', { method: 'POST' });
        const data = await res.json();
        statusEl.textContent = `训练完成：MAE=${data.metrics.mae.toFixed(3)} R²=${data.metrics.r2.toFixed(3)}; 天气相关性=${JSON.stringify(data.weather_correlation)}`;
      }

      async function loadPrediction() {
        const species = document.getElementById('species').value;
        statusEl.textContent = `加载${species}预测结果...`;
        const res = await fetch(`/api/predict?species=${species}`);
        const data = await res.json();
        const p = data.points;

        const trace = {
          type: 'scattergeo',
          mode: 'markers',
          lat: p.map(x => x.grid_lat),
          lon: p.map(x => x.grid_lon),
          text: p.map(x => `日期:${x.event_date}<br>预测捕获指数:${x.predicted_catch_index.toFixed(2)}<br>可信度:${x.confidence.toFixed(2)}<br>SST:${x.sst}`),
          marker: {
            size: p.map(x => 8 + x.confidence * 15),
            color: p.map(x => x.predicted_catch_index),
            colorscale: 'Turbo',
            colorbar: { title: 'Predicted Catch' },
            opacity: 0.8,
          }
        };

        const layout = {
          title: `${data.species} 预测可捕获指数与可信度地图`,
          geo: { projection: { type: 'natural earth' }, showland: true, landcolor: '#f3f3f3' },
        };
        Plotly.newPlot('chart', [trace], layout, { responsive: true });
        statusEl.textContent = `展示完成，共${p.length}个网格点。`;
      }
    </script>
  </body>
</html>
